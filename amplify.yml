version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "=== ENVIRONMENT VALIDATION ==="
        - echo "Node version:" && node --version
        - echo "NPM version:" && npm --version
        - echo "Checking required environment variables..."
        - 'test -n "$NEXT_PUBLIC_SUPABASE_URL" && echo "✅ NEXT_PUBLIC_SUPABASE_URL is set" || (echo "❌ NEXT_PUBLIC_SUPABASE_URL is missing" && exit 1)'
        - 'test -n "$NEXT_PUBLIC_SUPABASE_ANON_KEY" && echo "✅ NEXT_PUBLIC_SUPABASE_ANON_KEY is set" || (echo "❌ NEXT_PUBLIC_SUPABASE_ANON_KEY is missing" && exit 1)'
        - echo "=== PROJECT STRUCTURE ==="
        - ls -la next.config.js || echo "Warning: next.config.js not found"
        - 'cat package.json | grep -A 3 -B 3 "build"'
        - echo "=== INSTALLING DEPENDENCIES ==="
        - npm ci
        - echo "Dependencies installed successfully"
    build:
      commands:
        - echo "=== BUILDING APPLICATION ==="
        - npm run build
        - echo "=== BUILD VERIFICATION ==="
        - ls -la .next/
        - ls -la .next/server/ || echo "No server directory found"
        - ls -la .next/static/ || echo "No static directory found"
        - test -f .next/BUILD_ID && echo "✅ BUILD_ID exists" || echo "❌ BUILD_ID missing"
        - test -d .next/server/app && echo "✅ Server app directory exists" || echo "❌ Server app directory missing"
        - echo "Build completed successfully"
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*